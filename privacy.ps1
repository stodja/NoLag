Import-Module -DisableNameChecking $PSScriptRoot\..\lib\force-mkdir.psm1

Write-Output "Disabling telemetry via Group Policies"
force-mkdir "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection"
Set-ItemProperty "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" "AllowTelemetry" 0

Write-Output "Adding telemetry domains to hosts file"
$hosts_file = "$env:systemroot\System32\drivers\etc\hosts"
$domains = @(
    "1oavsblobprodcus350.blob.core.windows.net"
    "37bvsblobprodcus311.blob.core.windows.net"
    "a.ads1.msn.com"
    "a.ads2.msads.net"
    "a.ads2.msn.com"
    "a.rad.msn.com"
    "ac3.msn.com"
    "adnexus.net"
    "adnxs.com"
    "ads.msn.com"
    "ads1.msads.net"
    "ads1.msn.com"
    "aidps.atdmt.com"
    "aka-cdn-ns.adtech.de"
    "alpha.telemetry.microsoft.com"
    "api.cortana.ai"
    "api.edgeoffer.microsoft.com"
    "asimov-win.settings.data.microsoft.com.akadns.net"
    "azwancan.trafficmanager.net"
    "b.ads1.msn.com"
    "b.ads2.msads.net"
    "b.rad.msn.com"
    "bingads.microsoft.com"
    "blobcollector.events.data.trafficmanager.net"
    "bn2-ris-ap-prod-atm.trafficmanager.net"
    "bn2-ris-prod-atm.trafficmanager.net"
    "bn2wns1.wns.windows.com"
    "bn3sch020010558.wns.windows.com"
    "bn3sch020010560.wns.windows.com"
    "bn3sch020010618.wns.windows.com"
    "bn3sch020010629.wns.windows.com"
    "bn3sch020010631.wns.windows.com"
    "bn3sch020010635.wns.windows.com"
    "bn3sch020010636.wns.windows.com"
    "bn3sch020010650.wns.windows.com"
    "bn3sch020011727.wns.windows.com"
    "bn3sch020012850.wns.windows.com"
    "bn3sch020020322.wns.windows.com"
    "bn3sch020020749.wns.windows.com"
    "bn3sch020022328.wns.windows.com"
    "bn3sch020022335.wns.windows.com"
    "bn3sch020022361.wns.windows.com"
    "bn4sch101120814.wns.windows.com"
    "bn4sch101120818.wns.windows.com"
    "bn4sch101120911.wns.windows.com"
    "bn4sch101120913.wns.windows.com"
    "bn4sch101121019.wns.windows.com"
    "bn4sch101121109.wns.windows.com"
    "bn4sch101121118.wns.windows.com"
    "bn4sch101121223.wns.windows.com"
    "bn4sch101121407.wns.windows.com"
    "bn4sch101121618.wns.windows.com"
    "bn4sch101121704.wns.windows.com"
    "bn4sch101121709.wns.windows.com"
    "bn4sch101121714.wns.windows.com"
    "bn4sch101121908.wns.windows.com"
    "bn4sch101122117.wns.windows.com"
    "bn4sch101122310.wns.windows.com"
    "bn4sch101122312.wns.windows.com"
    "bn4sch101122421.wns.windows.com"
    "bn4sch101123108.wns.windows.com"
    "bn4sch101123110.wns.windows.com"
    "bn4sch101123202.wns.windows.com"
    "bn4sch102110124.wns.windows.com"
    "browser.pipe.aria.microsoft.com"
    "bs.serving-sys.com"
    "c.atdmt.com"
    "c.msn.com"
    "ca.telemetry.microsoft.com"
    "cache.datamart.windows.com"
    "cdn.atdmt.com"
    "cds1.stn.llnw.net"
    "cds10.stn.llnw.net"
    "cds27.ory.llnw.net"
    "cds1203.lon.llnw.net"
    "cds1204.lon.llnw.net"
    "cds1209.lon.llnw.net"
    "cds1219.lon.llnw.net"
    "cds1228.lon.llnw.net"
    "cds1244.lon.llnw.net"
    "cds1257.lon.llnw.net"
    "cds1265.lon.llnw.net"
    "cds1269.lon.llnw.net"
    "cds1273.lon.llnw.net"
    "cds1285.lon.llnw.net"
    "cds1287.lon.llnw.net"
    "cds1289.lon.llnw.net"
    "cds1293.lon.llnw.net"
    "cds1307.lon.llnw.net"
    "cds1310.lon.llnw.net"
    "cds1325.lon.llnw.net"
    "cds1327.lon.llnw.net"
    "cds177.dus.llnw.net"
    "cds20005.stn.llnw.net"
    "cds20404.lcy.llnw.net"
    "cds20411.lcy.llnw.net"
    "cds20415.lcy.llnw.net"
    "cds20416.lcy.llnw.net"
    "cds20417.lcy.llnw.net"
    "cds20424.lcy.llnw.net"
    "cds20425.lcy.llnw.net"
    "cds20431.lcy.llnw.net"
    "cds20435.lcy.llnw.net"
    "cds20440.lcy.llnw.net"
    "cds20443.lcy.llnw.net"
    "cds20445.lcy.llnw.net"
    "cds20450.lcy.llnw.net"
    "cds20452.lcy.llnw.net"
    "cds20457.lcy.llnw.net"
    "cds20461.lcy.llnw.net"
    "cds20469.lcy.llnw.net"
    "cds20475.lcy.llnw.net"
    "cds20482.lcy.llnw.net"
    "cds20485.lcy.llnw.net"
    "cds20495.lcy.llnw.net"
    "cds21205.lon.llnw.net"
    "cds21207.lon.llnw.net"
    "cds21225.lon.llnw.net"
    "cds21229.lon.llnw.net"
    "cds21233.lon.llnw.net"
    "cds21238.lon.llnw.net"
    "cds21244.lon.llnw.net"
    "cds21249.lon.llnw.net"
    "cds21256.lon.llnw.net"
    "cds21257.lon.llnw.net"
    "cds21258.lon.llnw.net"
    "cds21261.lon.llnw.net"
    "cds21267.lon.llnw.net"
    "cds21278.lon.llnw.net"
    "cds21281.lon.llnw.net"
    "cds21293.lon.llnw.net"
    "cds21309.lon.llnw.net"
    "cds21313.lon.llnw.net"
    "cds21321.lon.llnw.net"
    "cds299.lcy.llnw.net"
    "cds308.lcy.llnw.net"
    "cds30027.stn.llnw.net"
    "cds310.lcy.llnw.net"
    "cds38.ory.llnw.net"
    "cds54.ory.llnw.net"
    "cds405.lcy.llnw.net"
    "cds406.lcy.llnw.net"
    "cds407.fra.llnw.net"
    "cds416.lcy.llnw.net"
    "cds421.lcy.llnw.net"
    "cds422.lcy.llnw.net"
    "cds425.lcy.llnw.net"
    "cds426.lcy.llnw.net"
    "cds447.lcy.llnw.net"
    "cds458.lcy.llnw.net"
    "cds459.lcy.llnw.net"
    "cds46.ory.llnw.net"
    "cds461.lcy.llnw.net"
    "cds468.lcy.llnw.net"
    "cds469.lcy.llnw.net"
    "cds471.lcy.llnw.net"
    "cds483.lcy.llnw.net"
    "cds484.lcy.llnw.net"
    "cds489.lcy.llnw.net"
    "cds493.lcy.llnw.net"
    "cds494.lcy.llnw.net"
    "cds812.lon.llnw.net"
    "cds815.lon.llnw.net"
    "cds818.lon.llnw.net"
    "cds832.lon.llnw.net"
    "cds836.lon.llnw.net"
    "cds840.lon.llnw.net"
    "cds843.lon.llnw.net"
    "cds857.lon.llnw.net"
    "cds868.lon.llnw.net"
    "cds869.lon.llnw.net"
    "ceuswatcab01.blob.core.windows.net"
    "ceuswatcab02.blob.core.windows.net"
    "compatexchange1.trafficmanager.net"
    "corp.sts.microsoft.com"
    "corpext.msitadfs.glbdns2.microsoft.com"
    "cs1.wpc.v0cdn.net"
    "cy2.vortex.data.microsoft.com.akadns.net"
    "db3aqu.atdmt.com"
    "db5.settings.data.microsoft.com.akadns.net"
    "db5.settings-win.data.microsoft.com.akadns.net"
    "db5.vortex.data.microsoft.com.akadns.net"
    "db5-eap.settings-win.data.microsoft.com.akadns.net"
    "df.telemetry.microsoft.com"
    "diagnostics.support.microsoft.com"
    "eaus2watcab01.blob.core.windows.net"
    "eaus2watcab02.blob.core.windows.net"
    "ec.atdmt.com"
    "flex.msn.com"
    "g.msn.com"
    "geo.settings.data.microsoft.com.akadns.net"
    "geo.settings-win.data.microsoft.com.akadns.net"
    "geo.vortex.data.microsoft.com.akadns.net"
    "h1.msn.com"
    "h2.msn.com"
    "hk2.settings.data.microsoft.com.akadns.net"
    "hk2.wns.windows.com"
    "hk2sch130020721.wns.windows.com"
    "hk2sch130020723.wns.windows.com"
    "hk2sch130020726.wns.windows.com"
    "hk2sch130020729.wns.windows.com"
    "hk2sch130020732.wns.windows.com"
    "hk2sch130020824.wns.windows.com"
    "hk2sch130020843.wns.windows.com"
    "hk2sch130020851.wns.windows.com"
    "hk2sch130020854.wns.windows.com"
    "hk2sch130020855.wns.windows.com"
    "hk2sch130020924.wns.windows.com"
    "hk2sch130020936.wns.windows.com"
    "hk2sch130020940.wns.windows.com"
    "hk2sch130020956.wns.windows.com"
    "hk2sch130020958.wns.windows.com"
    "hk2sch130020961.wns.windows.com"
    "hk2sch130021017.wns.windows.com"
    "hk2sch130021029.wns.windows.com"
    "hk2sch130021035.wns.windows.com"
    "hk2sch130021137.wns.windows.com"
    "hk2sch130021142.wns.windows.com"
    "hk2sch130021153.wns.windows.com"
    "hk2sch130021217.wns.windows.com"
    "hk2sch130021246.wns.windows.com"
    "hk2sch130021249.wns.windows.com"
    "hk2sch130021260.wns.windows.com"
    "hk2sch130021264.wns.windows.com"
    "hk2sch130021322.wns.windows.com"
    "hk2sch130021323.wns.windows.com"
    "hk2sch130021329.wns.windows.com"
    "hk2sch130021334.wns.windows.com"
    "hk2sch130021360.wns.windows.com"
    "hk2sch130021432.wns.windows.com"
    "hk2sch130021433.wns.windows.com"
    "hk2sch130021435.wns.windows.com"
    "hk2sch130021437.wns.windows.com"
    "hk2sch130021440.wns.windows.com"
    "hk2sch130021450.wns.windows.com"
    "hk2sch130021518.wns.windows.com"
    "hk2sch130021523.wns.windows.com"
    "hk2sch130021526.wns.windows.com"
    "hk2sch130021527.wns.windows.com"
    "hk2sch130021544.wns.windows.com"
    "hk2sch130021554.wns.windows.com"
    "hk2sch130021618.wns.windows.com"
    "hk2sch130021634.wns.windows.com"
    "hk2sch130021638.wns.windows.com"
    "hk2sch130021646.wns.windows.com"
    "hk2sch130021652.wns.windows.com"
    "hk2sch130021654.wns.windows.com"
    "hk2sch130021657.wns.windows.com"
    "hk2sch130021723.wns.windows.com"
    "hk2sch130021726.wns.windows.com"
    "hk2sch130021727.wns.windows.com"
    "hk2sch130021730.wns.windows.com"
    "hk2sch130021731.wns.windows.com"
    "hk2sch130021754.wns.windows.com"
    "hk2sch130021829.wns.windows.com"
    "hk2sch130021830.wns.windows.com"
    "hk2sch130021833.wns.windows.com"
    "hk2sch130021840.wns.windows.com"
    "hk2sch130021842.wns.windows.com"
    "hk2sch130021851.wns.windows.com"
    "hk2sch130021852.wns.windows.com"
    "hk2sch130021927.wns.windows.com"
    "hk2sch130021928.wns.windows.com"
    "hk2sch130021929.wns.windows.com"
    "hk2sch130021958.wns.windows.com"
    "hk2sch130022035.wns.windows.com"
    "hk2sch130022041.wns.windows.com"
    "hk2sch130022049.wns.windows.com"
    "hk2sch130022135.wns.windows.com"
    "hk2wns1.wns.windows.com"
    "hk2wns1b.wns.windows.com"
    "ieonlinews.microsoft.com"
    "ieonlinews.trafficmanager.net"
    "insideruser.trafficmanager.net"
    "kmwatson.events.data.microsoft.com"
    "kmwatsonc.events.data.microsoft.com"
    "lb1.www.ms.akadns.net"
    "live.rads.msn.com"
    "m.adnxs.com"
    "mobile.pipe.aria.microsoft.com"
    "modern.watson.data.microsoft.com.akadns.net"
    "msedge.net"
    "msntest.serving-sys.com"
    "nexus.officeapps.live.com"
    "nexusrules.officeapps.live.com"
    "nw-umwatson.events.data.microsoft.com"
    "oca.telemetry.microsoft.com"
    "oca.telemetry.microsoft.us"
    "onecollector.cloudapp.aria.akadns.net"
    "par02p.wns.windows.com"
    "pre.footprintpredict.com"
    "presence.teams.live.com"
    "preview.msn.com"
    "rad.live.com"
    "rad.msn.com"
    "redir.metaservices.microsoft.com"
    "reports.wes.df.telemetry.microsoft.com"
    "romeccs.microsoft.com"
    "schemas.microsoft.akadns.net"
    "secure.adnxs.com"
    "secure.flashtalking.com"
    "services.wes.df.telemetry.microsoft.com"
    "settings-sandbox.data.microsoft.com"
    "settings-win-ppe.data.microsoft.com"
    "settings.data.glbdns2.microsoft.com"
    "settingsfd-geo.trafficmanager.net"
    "sg2p.wns.windows.com"
    "spynet2.microsoft.com"
    "spynetalt.microsoft.com"
    "spyneteurope.microsoft.akadns.net"
    "sqm.df.telemetry.microsoft.com"
    "sqm.telemetry.microsoft.com"
    "sqm.telemetry.microsoft.com.nsatc.net"
    "ssw.live.com"
    "survey.watson.microsoft.com"
    "tele.trafficmanager.net"
    "telecommand.telemetry.microsoft.com"
    "telemetry.appex.bing.net"
    "telemetry.microsoft.com"
    "telemetry.remoteapp.windowsazure.com"
    "telemetry.urs.microsoft.com"
    "teredo.ipv6.microsoft.com"
    "test.activity.windows.com"
    "uks.b.prd.ags.trafficmanager.net"
    "umwatson.events.data.microsoft.com"
    "umwatsonc.events.data.microsoft.com"
    "umwatsonc.telemetry.microsoft.us"
    "v10.vortex-win.data.microsoft.com"
    "v10-win.vortex.data.microsoft.com.akadns.net"
    "v20.vortex-win.data.microsoft.com"
    "view.atdmt.com"
    "vortex-sandbox.data.microsoft.com"
    "vortex.data.glbdns2.microsoft.com"
    "vortex.data.microsoft.com"
    "watson.live.com"
    "watson.microsoft.com"
    "watson.ppe.telemetry.microsoft.com"
    "watson.telemetry.microsoft.com"
    "web.vortex.data.microsoft.com"
    "wes.df.telemetry.microsoft.com"
    "weus2watcab01.blob.core.windows.net"
    "weus2watcab02.blob.core.windows.net"
    "win10.ipv6.microsoft.com"
    "win1710.ipv6.microsoft.com"
    "win8.ipv6.microsoft.com"
    "xblgdvrassets3010.blob.core.windows.net"
    "ztd.dds.microsoft.com"

)
Write-Output "" | Out-File -Encoding ASCII -Append $hosts_file
foreach ($domain in $domains) {
    if (-Not (Select-String -Path $hosts_file -Pattern $domain)) {
        Write-Output "0.0.0.0 $domain" | Out-File -Encoding ASCII -Append $hosts_file
    }
}

Write-Output "Adding telemetry IPs to firewall"
$ips = @(
    "13.64.90.137"
    "13.68.31.193"
    "13.69.131.175"
    "13.66.56.243"
    "13.68.82.8"
    "13.68.92.143"
    "13.68.233.9"
    "13.69.109.130"
    "13.69.109.131"
    "13.73.26.107"
    "13.74.169.109"
    "13.78.130.220"
    "13.78.232.226"
    "13.78.233.133"
    "13.88.21.125"
    "13.92.194.212"
    "13.104.215.69"
    "13.105.28.32"
    "13.105.28.48"
    "20.44.86.43"
    "20.49.150.241"
    "20.54.232.160"
    "20.60.20.4"
    "20.69.137.228"
    "20.190.169.24"
    "20.190.169.25"
    "23.99.49.121"
    "23.102.4.253"
    "23.102.5.5"
    "23.102.21.4"
    "23.103.182.126"
    "40.68.222.212"
    "40.69.153.67"
    "40.70.184.83"
    "40.70.220.248"
    "40.77.228.47"
    "40.77.228.87"
    "40.77.228.92"
    "40.77.232.101"
    "40.78.128.150"
    "40.79.85.125"
    "40.88.32.150"
    "40.112.209.200"
    "40.115.3.210"
    "40.115.119.185"
    "40.119.211.203"
    "40.124.34.70"
    "40.126.41.96"
    "40.126.41.160"
    "51.104.136.2"
    "51.105.218.222"
    "51.140.40.236"
    "51.140.157.153"
    "51.143.53.152"
    "51.143.111.7"
    "51.143.111.81"
    "51.144.227.73"
    "52.147.198.201"
    "52.138.204.217"
    "52.155.94.78"
    "52.157.234.37"
    "52.158.208.111"
    "52.164.241.205"
    "52.169.189.83"
    "52.170.83.19"
    "52.174.22.246"
    "52.178.147.240"
    "52.178.151.212"
    "52.178.223.23"
    "52.182.141.63"
    "52.183.114.173"
    "52.184.221.185"
    "52.229.39.152"
    "52.230.85.180"
    "52.230.222.68"
    "52.236.42.239"
    "52.236.43.202"
    "52.255.188.83"
    "65.52.100.7"
    "65.52.100.9"
    "65.52.100.11"
    "65.52.100.91"
    "65.52.100.92"
    "65.52.100.93"
    "65.52.100.94"
    "65.52.161.64"
    "65.55.29.238"
    "65.55.83.120"
    "65.55.113.11"
    "65.55.113.12"
    "65.55.113.13"
    "65.55.176.90"
    "65.55.252.43"
    "65.55.252.63"
    "65.55.252.70"
    "65.55.252.71"
    "65.55.252.72"
    "65.55.252.93"
    "65.55.252.190"
    "65.55.252.202"
    "66.119.147.131"
    "104.41.207.73"
    "104.42.151.234"
    "104.43.137.66"
    "104.43.139.21"
    "104.43.139.144"
    "104.43.140.223"
    "104.43.193.48"
    "104.43.228.53"
    "104.43.228.202"
    "104.43.237.169"
    "104.45.11.195"
    "104.45.214.112"
    "104.46.1.211"
    "104.46.38.64"
    "104.46.162.224"
    "104.46.162.226"
    "104.210.4.77"
    "104.210.40.87"
    "104.210.212.243"
    "104.214.35.244"
    "104.214.78.152"
    "131.253.6.87"
    "131.253.6.103"
    "131.253.34.230"
    "131.253.34.234"
    "131.253.34.237"
    "131.253.34.243"
    "131.253.34.246"
    "131.253.34.247"
    "131.253.34.249"
    "131.253.34.252"
    "131.253.34.255"
    "131.253.40.37"
    "134.170.30.202"
    "134.170.30.203"
    "134.170.30.204"
    "134.170.30.221"
    "134.170.52.151"
    "134.170.235.16"
    "157.56.74.250"
    "157.56.91.77"
    "157.56.106.184"
    "157.56.106.185"
    "157.56.106.189"
    "157.56.113.217"
    "157.56.121.89"
    "157.56.124.87"
    "157.56.149.250"
    "157.56.194.72"
    "157.56.194.73"
    "157.56.194.74"
    "168.61.24.141"
    "168.61.146.25"
    "168.61.149.17"
    "168.61.161.212"
    "168.61.172.71"
    "168.62.187.13"
    "168.63.100.61"
    "168.63.108.233"
    "191.236.155.80"
    "191.237.218.239"
    "191.239.50.18"
    "191.239.50.77"
    "191.239.52.100"
    "191.239.54.52"
    "207.68.166.254"
)
Remove-NetFirewallRule -DisplayName "NoLag Privacy Lock 🔒" -ErrorAction SilentlyContinue
New-NetFirewallRule -DisplayName "NoLag Privacy Lock 🔒" -Direction Outbound `
    -Action Block -RemoteAddress ([string[]]$ips)